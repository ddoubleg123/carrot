Step,Action,Resource/URL,Operation,Database Table,Status/Decision,Score/Reason,Notes
1,Add to Monitoring,https://en.wikipedia.org/wiki/Zionism,Add Wikipedia page to monitoring queue,wikipediaMonitoring,status: pending,,"Page added to monitoring table with status 'pending'. Stores: wikipediaTitle='Zionism', wikipediaUrl, patchId"
2,Get Next Page,https://en.wikipedia.org/wiki/Zionism,Select next Wikipedia page to process,wikipediaMonitoring,status: processing,,"Query selects page with status 'pending', updates to 'processing'"
3,Fetch HTML,https://en.wikipedia.org/wiki/Zionism,Fetch full HTML from Wikipedia API,None,HTTP 200,,"Fetches HTML from Wikipedia REST API: /page/html/Zionism. Gets full page HTML for citation extraction"
4,Extract Citations,https://en.wikipedia.org/wiki/Zionism,Extract all citations from HTML using extractWikipediaCitationsWithContext,None,Found ~200+ citations,,"Extracts from: References section (<ol class='references'>), Further reading, External links. Separates external URLs from Wikipedia internal links (./, /wiki/, wikipedia.org)"
5,Prioritize External Citations,External URLs only,Score external URLs using DeepSeek AI,wikipediaCitation,aiPriorityScore: 0-100,,"Only external URLs get scored via prioritizeCitations(). Wikipedia internal links get default score 50. Example: 'https://d-nb.info/gnd/4067864-7' (GND) would get low score"
6,Store External Citations,External URLs,Store external citations in database,wikipediaCitation,verificationStatus: pending,aiPriorityScore: 0-100,"Example citations stored: GND, BnF, NARA, İslâm Ansiklopedisi, etc. verificationStatus='pending' for external URLs"
7,Store Wikipedia Internal Links,Wikipedia internal URLs,Store Wikipedia links separately,wikipediaCitation,verificationStatus: pending_wiki,aiPriorityScore: 50,"Example: './Portal:Politics', './Portal:Palestine', './Portal:Judaism'. verificationStatus='pending_wiki' to defer processing"
8,Mark Citations Extracted,https://en.wikipedia.org/wiki/Zionism,Update monitoring record,wikipediaMonitoring,citationsExtracted: true,citationCount: ~200+,"Sets citationsExtracted=true, stores citationCount. Page ready for citation processing"
9,Get Next Citation (External First),First external URL (e.g. GND),Select next citation to process,wikipediaCitation,scanStatus: not_scanned,,"Query: verificationStatus IN ['pending','verified'], scanStatus='not_scanned', excludes Wikipedia URLs. Prioritizes by aiPriorityScore DESC"
10,Check Rate Limit,External URL domain (e.g. d-nb.info),Check if domain is rate-limited,None,canProcess: true/false,,"Prevents processing too many URLs from same domain. Rate limit per domain"
11,Check Wikipedia Link,External URL,Check if URL is Wikipedia internal link,wikipediaCitation,isWikipediaUrl: false,,"If Wikipedia URL (contains 'wikipedia.org/wiki/'), goes to step 12. Otherwise continues to step 13"
12,Process Wikipedia Internal Link,Wikipedia internal URL (e.g. ./Portal:Politics),Fetch page, check relevance, add to monitoring if relevant,wikipediaMonitoring,Added if score >= 40,score >= 40,"Uses checkWikipediaPageRelevance (threshold 40). Fetches page HTML, extracts text, scores relevance. If relevant, adds to monitoring. Marks citation as 'denied' with reason 'added to monitoring'"
13,Check Low Quality,External URL (e.g. GND),Check if URL is library catalog/metadata page,wikipediaCitation,isLowQuality: true,,"If low quality (VIAF, GND, WorldCat, BnF, NARA, etc.), marks as denied immediately. Example: 'https://d-nb.info/gnd/4067864-7' would be denied"
14,Check Duplicate,External URL,Check if URL already in DiscoveredContent,DiscoveredContent,exists: false,,"If duplicate (canonicalUrl matches), marks citation as 'saved' and skips processing"
15,Mark Verifying,External URL,Update citation status,wikipediaCitation,verificationStatus: verifying,,"Updates status to 'verifying' before attempting HTTP request"
16,Verify URL (HEAD),External URL,Attempt HEAD request to verify URL exists,None,HTTP status (200/404/etc),,"Tries HEAD first (lightweight). Falls back to GET if HEAD fails or domain requires GET (gov.il, nba.com, espn.com, wikipedia.org)"
17,Verify URL (GET),External URL,Fallback to GET if HEAD failed,None,HTTP status,,"GET request with 30s timeout. Stores HTML for extraction if successful"
18,Mark Scanning,External URL,Update citation status,wikipediaCitation,scanStatus: scanning,,"Updates status to 'scanning' before content extraction"
19,Extract Content (Readability),External URL,Extract text content using Readability,None,extractionMethod: readability,,"Tries Readability first (best for news/blogs). Needs >= 600 chars to use this method"
20,Extract Content (ContentExtractor),External URL,Fallback to ContentExtractor,None,extractionMethod: content-extractor,,"If Readability fails or < 600 chars, tries ContentExtractor (better boilerplate removal)"
21,Extract Content (Fallback),External URL,Last resort: strip HTML tags,None,extractionMethod: fallback-strip,,"Ultra last resort: strips <script>, <style>, <noscript>, then all HTML tags. Only used if other methods fail"
22,Validate Content Length (500 chars),External URL,Check if content meets minimum length,wikipediaCitation,hasSufficientContent: true,,"Minimum 500 chars to continue. If < 500, marks as denied with reason 'insufficient content'"
23,Validate Content Length (600 chars),External URL,Check if content sufficient for AI scoring,wikipediaCitation,hasSufficientContent: true,,"Minimum 600 chars for AI scoring. If < 600, marks as denied with reason 'min_len_600_for_ai'"
24,Score Content (DeepSeek),External URL,Score content relevance using DeepSeek AI,wikipediaCitation,aiPriorityScore: 0-100,isRelevant: true/false,"Uses scoreCitationContent(). Checks: 1) Is actual article? 2) Relevance to topic? 3) Content quality? Returns score 0-100 and isRelevant boolean"
25,Check Is Article,External URL,Verify content is actual article not metadata,wikipediaCitation,isActuallyAnArticle: true/false,,"Checks paragraph count, text length, article indicators. If not article, returns score 30 and isRelevant=false"
26,Check Relevance Threshold,External URL,Check if score meets threshold,wikipediaCitation,meetsThreshold: true/false,score >= 60,"RELEVANCE_THRESHOLD = 60. Must have score >= 60 AND isRelevant=true to save"
27,Optional RelevanceEngine Check,External URL,Secondary validation using RelevanceEngine,None,relevanceEngineScore: 0-1,,"Optional check. Can override if strongly disagrees. Not required for save"
28,Save to DiscoveredContent,External URL,Save relevant citation to DiscoveredContent,DiscoveredContent,saved: true,aiScore >= 60,"Only saves if finalIsRelevant=true AND saveAsContent function provided. Stores: canonicalUrl, title, content, aiScore, relevanceScore"
29,Mark Citation Scanned,External URL,Update citation with final decision,wikipediaCitation,scanStatus: scanned,relevanceDecision: saved/denied,"Stores: relevanceDecision ('saved' or 'denied'), discoveredContentId (if saved), extractedContent, aiPriorityScore"
30,Mark Citation Verification,External URL,Update verification status,wikipediaCitation,verificationStatus: verified/failed,,"If saved: verificationStatus='verified'. If denied: verificationStatus='failed' with reason"
31,Mark Page Complete Check,https://en.wikipedia.org/wiki/Zionism,Check if all citations processed,wikipediaMonitoring,status: completed,,"If all citations have scanStatus IN ['scanned','scanned_denied'], marks page as 'completed'"
32,Repeat for Next Citation,Next external URL,Process next citation from queue,wikipediaCitation,Continues,,"Loops back to step 9 for next citation. Processes external URLs first (verificationStatus='pending')"
33,Process Wikipedia Internal Links,Wikipedia internal URLs (e.g. ./Portal:Politics),After external URLs done, process Wikipedia links,wikipediaMonitoring,Added if relevant,score >= 40,"Wikipedia links (verificationStatus='pending_wiki') checked for relevance. If relevant (score >= 40), added to monitoring for recursive crawling"
34,Recursive Crawling,New Wikipedia pages (e.g. Portal:Politics),Pages added to monitoring get processed,wikipediaMonitoring,Recursive,,"Pages added in step 12 or 33 get processed through same flow starting at step 2. This creates recursive Wikipedia-to-Wikipedia crawling"

SPECIFIC EXAMPLES FROM ZIONISM PAGE:
Example 1 - GND (Library Catalog),Check Low Quality,https://d-nb.info/gnd/4067864-7,Detected as library catalog,wikipediaCitation,denied,isLowQuality: true,"GND (German National Library) - immediately denied at step 13, never fetched"
Example 2 - BnF (Library Catalog),Check Low Quality,https://catalogue.bnf.fr/ark:/12148/cb11934332w,Detected as library catalog,wikipediaCitation,denied,isLowQuality: true,"BnF (French National Library) - immediately denied at step 13"
Example 3 - Portal Page,Process Wikipedia Link,./Portal:Politics,Wikipedia internal link,wikipediaCitation,Added to monitoring,score >= 40,"If relevant to topic (score >= 40), added to wikipediaMonitoring. Citation marked as 'denied' but page added for crawling"
Example 4 - External Article,Full Processing,https://example-news-article.com/zionism,External URL - full flow,DiscoveredContent,saved,score >= 60,"If score >= 60 AND isRelevant=true, saved to DiscoveredContent. Full content extracted and stored"
Example 5 - Low Score Article,Score Content,https://example-low-relevance.com,External URL - scored low,wikipediaCitation,denied,score < 60,"If score < 60 OR isRelevant=false, marked as denied. Content still stored in wikipediaCitation.extractedContent for audit"

BROKEN SPOTS IDENTIFIED:
Issue 1,Wikipedia Internal Links Not Processed,Wikipedia internal URLs with verificationStatus='pending_wiki',getNextCitationToProcess excludes pending_wiki,wikipediaCitation,stuck in not_scanned,,"Query filters out verificationStatus='pending_wiki', so Wikipedia links never get processed unless manually triggered"
Issue 2,Portal Pages Denied,Portal pages (e.g. Portal:Politics),scoreCitationContent rejects non-articles,wikipediaCitation,denied,score: 30,"Portal pages get score 30 because they're not 'articles'. Should use checkWikipediaPageRelevance instead (FIXED)"
Issue 3,All Citations Score 30,Metadata pages (GND, BnF, etc.),isActuallyAnArticle returns false,wikipediaCitation,denied,score: 30,"Metadata pages correctly get score 30, but legitimate articles might also get 30 if content extraction fails"
Issue 4,No Citations Saved,All citations,score < 60 OR isRelevant=false OR saveAsContent not provided,DiscoveredContent,0 saved,,"If all citations score < 60, nothing gets saved. Need to check: 1) Are citations actually relevant? 2) Is saveAsContent function provided? 3) Is content extraction working?"
Issue 5,Undefined Wikipedia Title,Wikipedia pages,getNextWikipediaPageToProcess doesn't select wikipediaTitle,wikipediaMonitoring,error: undefined,,"If wikipediaTitle is null, causes errors when processing. Should extract from URL (FIXED)"
